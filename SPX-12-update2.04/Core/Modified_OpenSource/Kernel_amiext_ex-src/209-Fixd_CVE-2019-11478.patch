diff -Naur linux_org/include/uapi/linux/snmp.h linux/include/uapi/linux/snmp.h
--- linux_org/include/uapi/linux/snmp.h	2019-07-10 14:05:15.930879350 +0800
+++ linux/include/uapi/linux/snmp.h	2019-07-10 14:25:01.942114970 +0800
@@ -259,6 +259,7 @@
 	LINUX_MIB_TCPSPURIOUS_RTX_HOSTQUEUES, /* TCPSpuriousRtxHostQueues */
 	LINUX_MIB_BUSYPOLLRXPACKETS,		/* BusyPollRxPackets */
 	LINUX_MIB_TCPAUTOCORKING,		/* TCPAutoCorking */
+	LINUX_MIB_TCPWQUEUETOOBIG,		/* TCPWqueueTooBig */
 	__LINUX_MIB_MAX
 };
 
diff -Naur linux_org/net/ipv4/proc.c linux/net/ipv4/proc.c
--- linux_org/net/ipv4/proc.c	2019-07-10 14:05:26.082431826 +0800
+++ linux/net/ipv4/proc.c	2019-07-10 14:25:36.307959583 +0800
@@ -280,6 +280,7 @@
 	SNMP_MIB_ITEM("TCPSpuriousRtxHostQueues", LINUX_MIB_TCPSPURIOUS_RTX_HOSTQUEUES),
 	SNMP_MIB_ITEM("BusyPollRxPackets", LINUX_MIB_BUSYPOLLRXPACKETS),
 	SNMP_MIB_ITEM("TCPAutoCorking", LINUX_MIB_TCPAUTOCORKING),
+	SNMP_MIB_ITEM("TCPWqueueTooBig", LINUX_MIB_TCPWQUEUETOOBIG),
 	SNMP_MIB_SENTINEL
 };
 
diff -Naur linux_org/net/ipv4/tcp_output.c linux/net/ipv4/tcp_output.c
--- linux_org/net/ipv4/tcp_output.c	2019-07-10 14:22:48.956755060 +0800
+++ linux/net/ipv4/tcp_output.c	2019-07-10 14:26:27.061899419 +0800
@@ -1085,6 +1085,11 @@
 	if (nsize < 0)
 		nsize = 0;
 
+	if (unlikely((sk->sk_wmem_queued >> 1) > sk->sk_sndbuf)) {
+		NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPWQUEUETOOBIG);
+		return -ENOMEM;
+	}	
+	
 	if (skb_unclone(skb, GFP_ATOMIC))
 		return -ENOMEM;
 
