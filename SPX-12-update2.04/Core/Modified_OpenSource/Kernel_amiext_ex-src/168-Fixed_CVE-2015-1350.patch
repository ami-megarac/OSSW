diff -Naur linux_org/fs/attr.c linux/fs/attr.c
--- linux_org/fs/attr.c	2019-03-28 10:35:31.760400389 +0800
+++ linux/fs/attr.c	2019-03-28 10:47:03.746704810 +0800
@@ -262,11 +262,23 @@
 	if (error)
 		return error;
 
+	/* Smuggle the dentry through to inode_change_ok() */
+	if (!(attr->ia_valid & ATTR_FILE)) {
+		attr->ia_file = (struct file *)dentry;
+		attr->ia_valid |= ATTR_DENTRY;
+	}	
+	
 	if (inode->i_op->setattr)
 		error = inode->i_op->setattr(dentry, attr);
 	else
 		error = simple_setattr(dentry, attr);
 
+	if (attr->ia_valid & ATTR_DENTRY) {
+		if (!(attr->ia_valid & ATTR_FILE))
+			attr->ia_file = NULL;
+		attr->ia_valid &= ~ATTR_DENTRY;
+	}	
+	
 	if (!error) {
 		fsnotify_change(dentry, ia_valid);
 		ima_inode_post_setattr(dentry);
diff -Naur linux_org/include/linux/fs.h linux/include/linux/fs.h
--- linux_org/include/linux/fs.h	2019-03-28 10:35:21.484921859 +0800
+++ linux/include/linux/fs.h	2019-03-28 10:37:26.276489149 +0800
@@ -216,6 +216,7 @@
 #define ATTR_KILL_PRIV	(1 << 14)
 #define ATTR_OPEN	(1 << 15) /* Truncating from open(O_TRUNC) */
 #define ATTR_TIMES_SET	(1 << 16)
+#define ATTR_DENTRY	(1 << 18) /* ia_file is actually a dentry */
 
 /*
  * This is the Inode Attributes structure, used for notify_change().  It
