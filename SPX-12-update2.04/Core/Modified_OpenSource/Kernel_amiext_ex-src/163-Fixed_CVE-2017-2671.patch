diff -Naur linux_org/net/ipv4/ping.c linux/net/ipv4/ping.c
--- linux_org/net/ipv4/ping.c	2019-03-27 14:09:52.611896548 +0800
+++ linux/net/ipv4/ping.c	2019-03-27 15:15:31.055472028 +0800
@@ -155,15 +155,15 @@
 {
 	struct inet_sock *isk = inet_sk(sk);
 	pr_debug("ping_unhash(isk=%p,isk->num=%u)\n", isk, isk->inet_num);
+	write_lock_bh(&ping_table.lock);
 	if (sk_hashed(sk)) {
-		write_lock_bh(&ping_table.lock);
 		hlist_nulls_del(&sk->sk_nulls_node);
 		sock_put(sk);
 		isk->inet_num = 0;
 		isk->inet_sport = 0;
 		sock_prot_inuse_add(sock_net(sk), sk->sk_prot, -1);
-		write_unlock_bh(&ping_table.lock);
 	}
+	write_unlock_bh(&ping_table.lock);
 }
 EXPORT_SYMBOL_GPL(ping_unhash);
 
