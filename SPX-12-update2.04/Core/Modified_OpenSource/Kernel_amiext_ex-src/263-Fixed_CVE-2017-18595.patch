--- a/kernel/trace/trace.c	2019-09-24 16:16:23.452462072 +0800
+++ b/kernel/trace/trace.c	2019-09-24 16:23:28.320328484 +0800
@@ -6006,6 +6006,7 @@
 	buf->data = alloc_percpu(struct trace_array_cpu);
 	if (!buf->data) {
 		ring_buffer_free(buf->buffer);
+		buf->buffer = NULL;
 		return -ENOMEM;
 	}
 
